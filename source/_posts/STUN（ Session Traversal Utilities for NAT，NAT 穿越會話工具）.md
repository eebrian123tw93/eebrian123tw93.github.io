---
title: STUN（ Session Traversal Utilities for NAT，NAT 穿越會話工具）
date: '2024-12-23 11:50:00'
updated: '2025-02-19 08:51:03'
categories: []
description: ''
abbrlink: d4e6d128
tags:
  - WebRTC
keywords:
  - WebRTC
---
STUN（Session Traversal Utilities for NAT，NAT 穿越會話工具）是一種網絡協議，用於協助用戶端通過 NAT（網絡地址轉換）和防火牆發現其**公共 IP 地址和端口**。STUN 的主要目的是幫助建立點對點連接，尤其是在使用 NAT 和防火牆的網絡環境中，例如即時通訊或視頻通話等應用。

NAT 自己不会告诉服务器它是什么类型的，我们需要一套交互式策略检测对应的类型
 <!-- more -->
 
RFC 3489 
![](/images/20241223104352.png)
此演算法在RFC 3489被提出，但在RFC 5389中被刪除。
### **STUN 的主要功能**

1. **發現公共 IP 地址和端口**： STUN 協議允許用戶端詢問 STUN 伺服器，用戶端的公共 IP 地址和伺服器看到的端口號是什麼。
2. **檢測 NAT 類型**： STUN 能夠幫助用戶端檢測 NAT 的類型（如全錐形 NAT、限制錐形 NAT、對稱 NAT 等），以便了解網絡條件。
3. **協助 P2P 連接**： 通過 STUN，兩個位於 NAT 後的用戶端可以交換公共地址，嘗試建立直接的點對點連接。
### **STUN 的工作原理**

1. **用戶端請求**： 用戶端向 STUN 伺服器發送一個包含其本地 IP 和端口的請求。
2. **伺服器響應**： STUN 伺服器收到請求後，根據其視角返回用戶端的公共 IP 地址和端口。
3. **NAT 類型檢測**： 通過改變請求的參數，例如更換來源地址、使用不同的伺服器，STUN 可以分析 NAT 的行為，判斷是哪種類型的 NAT。
### **STUN 協議的用途**

- **WebRTC 通信**： 在 WebRTC 中，STUN 是一個關鍵技術，用於讓瀏覽器間建立直接連接。
- **VoIP 和視頻會議**： 如 Skype、Zoom 等應用會利用 STUN 來協助穿越 NAT。
- **在線遊戲**： 幫助遊戲客戶端在 NAT 後通信。
### **STUN 和其他 NAT 穿越技術**
1. **STUN**： 用於發現公共地址和協助直接通信。適用於全錐形 NAT 和部分限制錐形 NAT。
2. **TURN（Traversal Using Relays around NAT）**： 當直接連接不可行時（如對稱 NAT），TURN 允許數據通過中繼伺服器傳輸。
3. **ICE（Interactive Connectivity Establishment）**： 綜合使用 STUN 和 TURN 的技術，幫助選擇最佳的通信路徑。
---
### **STUN 的限制**

- **對稱 NAT 支持有限**： 對於對稱 NAT，用戶端通常無法直接建立連接，需要配合 TURN 使用。
- **依賴 STUN 伺服器**： 必須配置和維護可靠的 STUN 伺服器，才能確保其正常運行。
- **安全性考量**： STUN 不加密數據，可能面臨中間人攻擊或地址偽造。

### **STUN 演算法的基本概念**

1. **NAT 類型檢測**：
    
    - 判斷 NAT 的行為，包括地址映射和數據包過濾規則。
    - 確定 NAT 是「全錐形 NAT」、「限制錐形 NAT」、「端口限制錐形 NAT」還是「對稱 NAT」。
2. **穿越測試**：
    
    - 利用多種測試組合檢測 NAT 穿越能力，確保應用程序可以建立有效的通信通道。

---

### **STUN 的主要測試步驟**

STUN 使用以下步驟和測試模式來檢測 NAT 的類型和行為：

#### **步驟 1: 發送基本測試 (Test I)**

1. **過程**：
    
    - 用戶端向 STUN 伺服器發送一個 Binding Request。
    - 該請求從用戶端的本地地址 `A` 發出，經過 NAT 之後，伺服器會看到轉換後的公共地址 `A'`。
    - 伺服器返回一個 Binding Response，其中包含 `MAPPED-ADDRESS`。
2. **結果解讀**：
    
    - 如果返回的 `MAPPED-ADDRESS` 與請求中的來源地址一致，表示沒有 NAT 或在同一局域網中。
    - 如果不同，則 NAT 存在，記錄公共地址。

---

#### **步驟 2: 發送不同來源地址的測試 (Test II)**

1. **過程**：
    
    - 用戶端向伺服器發送第二個請求，改變來源端口或地址。
    - 這一測試用於檢測 NAT 是否會對來源地址改變的數據包進行映射更新。
2. **結果解讀**：
    
    - 如果伺服器返回相同的地址，則 NAT 是錐形 NAT。
    - 如果伺服器返回的地址不同，則 NAT 是對稱 NAT。

---

#### **步驟 3: 使用不同伺服器的測試 (Test III)**

1. **過程**：
    
    - 用戶端向另一個 STUN 伺服器發送請求（伺服器 B）。
    - 比較伺服器 A 和 B 返回的地址。
2. **結果解讀**：
    
    - 如果伺服器 A 和 B 返回相同的公共地址，表示 NAT 為全錐形 NAT。
    - 如果返回的公共地址不同，表示 NAT 為對稱 NAT。

---

#### **步驟 4: 開啟目標伺服器測試 (Test IV)**

1. **過程**：
    
    - 用戶端向伺服器發送包含目標伺服器地址的請求。
    - 測試 NAT 是否允許數據包從特定外部地址進入。
2. **結果解讀**：
    
    - 如果伺服器能響應，表示 NAT 為限制錐形 NAT。
    - 如果伺服器無法響應，則 NAT 是端口限制錐形 NAT。

---

### **STUN 發現 NAT 類型的算法決策表**

下表簡要說明了 STUN 在不同步驟中的行為和決策：

|**測試步驟**|**返回地址是否一致**|**NAT 類型**|
|---|---|---|
|Test I|是|無 NAT 或防火牆|
||否|NAT 存在|
|Test II|是|錐形 NAT|
||否|對稱 NAT|
|Test III|是|全錐形 NAT|
||否|限制錐形或端口限制錐形 NAT|
|Test IV|是|限制錐形 NAT|
||否|端口限制錐形 NAT|

---

### **關於防火牆檢測**

- 防火牆的檢測基於數據包是否能到達伺服器。
- 如果所有測試數據包都無法響應，可能是防火牆完全阻止了 UDP 流量。